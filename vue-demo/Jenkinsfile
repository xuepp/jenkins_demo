pipeline {
  agent any
  environment {
    DOCKER_IMAGE = "vuedemo"
    DOCKER_TAG = "latest"
  }
  stages {
    // é˜¶æ®µ1ï¼šæ‹‰å–ä»£ç 
    stage('Checkout') {
      steps {
        echo "ğŸ¯ å¼€å§‹æ‹‰å–ä»£ç ä»“åº“..."
        git branch: 'main', url: 'https://github.com/xuepp/jenkins_demo.git'
        echo "âœ… ä»£ç æ‹‰å–å®Œæˆï¼"
      }
    }
    
    // é˜¶æ®µ2ï¼šæ„å»º Docker é•œåƒ
    stage('Build') {
      steps {
        script {
          echo "ğŸ”¨ å¼€å§‹æ„å»º Docker é•œåƒ..."
          // ä½¿ç”¨ --progress=plain å¼ºåˆ¶è¾“å‡ºæ„å»ºæ—¥å¿—
          docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}", "--progress=plain .")
          echo "âœ… é•œåƒæ„å»ºæˆåŠŸï¼"
          
          // å¯é€‰ï¼šåˆ—å‡ºé•œåƒéªŒè¯
          sh "docker images | grep ${DOCKER_IMAGE}"
        }
      }
    }
    
    // é˜¶æ®µ3ï¼šè¿è¡Œå®¹å™¨
    stage('Deploy') {
      steps {
        script {
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²å®¹å™¨..."
          
          // åœæ­¢æ—§å®¹å™¨ï¼ˆå¼ºåˆ¶è¾“å‡ºæ“ä½œæ—¥å¿—ï¼‰
          echo "â¹ åœæ­¢æ—§å®¹å™¨..."
          sh '''
            docker stop vuedemo || echo "æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨å¯åœæ­¢"
            docker rm vuedemo || echo "æ²¡æœ‰æ—§å®¹å™¨å¯åˆ é™¤"
          '''
          
          // å¯åŠ¨æ–°å®¹å™¨ï¼ˆå¸¦å®æ—¶æ—¥å¿—ï¼‰
          echo "ğŸ”„ å¯åŠ¨æ–°å®¹å™¨..."
          sh "docker run -d --name vuedemo -p 80:80 ${DOCKER_IMAGE}:${DOCKER_TAG}"
          
          // éªŒè¯å®¹å™¨çŠ¶æ€
          echo "ğŸ” æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
          sh "docker ps | grep vuedemo"
          echo "âœ… éƒ¨ç½²å®Œæˆï¼è®¿é—®åœ°å€ï¼šhttp://YOUR_SERVER_IP"
        }
      }
    }
  }
  
  // å¯é€‰ï¼šå…¨å±€æ—¥å¿—å¢å¼º
  post {
    always {
      echo "ğŸ“¢ æµæ°´çº¿æ‰§è¡ŒçŠ¶æ€ï¼š${currentBuild.result ?: 'SUCCESS'}"
    }
    failure {
      echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼"
    }
  }
}